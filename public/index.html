<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UniversityDB – Student & Course Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h1, h2, h3 {
      margin-top: 30px;
    }

    label {
      display: block;
      margin-top: 6px;
      font-size: 0.9rem;
    }

    input {
      padding: 4px 6px;
      margin-bottom: 4px;
      width: 220px;
    }

    button {
      margin-top: 8px;
      padding: 6px 10px;
      cursor: pointer;
    }

    hr {
      margin: 25px 0;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    .section {
      margin-bottom: 30px;
    }

    .row {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
    }

    .card {
      border: 1px solid #ddd;
      padding: 12px 16px;
      border-radius: 4px;
      max-width: 320px;
    }

    .small {
      font-size: 0.85rem;
      color: #555;
    }

    .status {
      margin-top: 6px;
      font-size: 0.9rem;
      color: #007700;
    }

    .status.error {
      color: #bb0000;
    }
  </style>
</head>
<body>
  <h1>University Database Demo</h1>
  <p class="small">
    Backend: Node + Express + MySQL, connected to <strong>universitydb</strong>.
  </p>

  <!-- =======================
       SECTION 1 – STUDENT CRUD
       ======================= -->
  <div class="section">
    <h2>Students</h2>

    <div class="row">
      <!-- Add student -->
      <div class="card">
        <h3>Add New Student</h3>
        <label for="studentNum">Student Number</label>
        <input id="studentNum" type="number" />

        <label for="fName">First Name</label>
        <input id="fName" type="text" />

        <label for="lName">Last Name</label>
        <input id="lName" type="text" />

        <label for="studentEmail">Email</label>
        <input id="studentEmail" type="email" />

        <label for="studentMainPhone">Phone</label>
        <input id="studentMainPhone" type="text" />

        <button id="btnAddStudent">Add Student</button>
        <div id="addStatus" class="status"></div>
      </div>

      <!-- Update student -->
      <div class="card">
        <h3>Update Student Contact</h3>
        <p class="small">Updates email + phone based on student number.</p>

        <label for="updStudentNum">Student Number</label>
        <input id="updStudentNum" type="number" />

        <label for="updEmail">New Email</label>
        <input id="updEmail" type="email" />

        <label for="updPhone">New Phone</label>
        <input id="updPhone" type="text" />

        <button id="btnUpdateStudent">Update Student</button>
        <div id="updateStatus" class="status"></div>
      </div>

      <!-- Delete student -->
      <div class="card">
        <h3>Delete Student</h3>
        <p class="small">Deletes the student row (careful!).</p>

        <label for="delStudentNum">Student Number</label>
        <input id="delStudentNum" type="number" />

        <button id="btnDeleteStudent">Delete Student</button>
        <div id="deleteStatus" class="status"></div>
      </div>
    </div>

    <hr />

    <!-- Controls for loading, searching, and paging -->
    <button id="btnViewStudents">Load Students</button>

    <div style="margin-top:10px; margin-bottom:10px;">
      <label class="small" for="studentSearch">
        Search (by #, first, last, or email):
      </label>
      <input id="studentSearch" type="text" style="width:260px;" />
      <button id="btnSearchStudents">Search</button>
      <button id="btnClearSearch">Clear</button>
    </div>

    <div style="margin-bottom:10px;">
      <button id="btnPrevPage">&laquo; Prev</button>
      <span id="pageInfo" class="small" style="margin:0 8px;"></span>
      <button id="btnNextPage">Next &raquo;</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Student #</th>
          <th>First</th>
          <th>Last</th>
          <th>Email</th>
          <th>Phone</th>
        </tr>
      </thead>
      <tbody id="studentsTableBody">
        <!-- filled by JS -->
      </tbody>
    </table>
  </div>

  <!-- =======================
       SECTION 2 – PROFESSOR COURSES
       ======================= -->
  <div class="section">
    <h2>Professor Courses (JOIN)</h2>
    <div class="card">
      <p class="small">
        Shows all courses taught by a given professor using
        <code>teaches</code> + <code>course</code>.
      </p>
      <label for="professorIDInput">Professor ID</label>
      <input id="professorIDInput" type="number" />
      <button id="btnProfessorCourses">View Professor Courses</button>
      <div id="profCourseStatus" class="status"></div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Course ID</th>
          <th>Course Name</th>
          <th>TA Name</th>
          <th>Dept Email</th>
        </tr>
      </thead>
      <tbody id="professorCoursesBody">
        <!-- filled by JS -->
      </tbody>
    </table>
  </div>

  <!-- =======================
       SECTION 3 – COURSE ENROLLMENT REPORT
       ======================= -->
  <div class="section">
    <h2>Course Enrollment Report (JOIN + GROUP BY)</h2>
    <div class="card">
      <p class="small">
        Uses a JOIN between <code>course</code> and <code>attends</code> plus
        <code>GROUP BY</code> to count students per course.
      </p>
      <button id="btnCourseEnrollment">Generate Report</button>
      <div id="enrollmentStatus" class="status"></div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Course ID</th>
          <th>Course Name</th>
          <th># Students</th>
        </tr>
      </thead>
      <tbody id="courseEnrollmentBody">
        <!-- filled by JS -->
      </tbody>
    </table>
  </div>

  <!-- =======================
     SECTION – FACULTY CRUD
     ======================= -->
<div class="section">
  <h2>Faculty</h2>

  <!-- Add Faculty Form -->
  <div class="card">
    <h3>Add Faculty</h3>
    <label>Name</label>
    <input type="text" id="facultyName" />

    <label>Office</label>
    <input type="text" id="facultyOffice" />

    <label>Phone</label>
    <input type="text" id="facultyMainPhone" />

    <label>Email</label>
    <input type="text" id="facultyEmail" />

    <button id="btnAddFaculty">Add Faculty</button>
    <div id="facultyAddStatus" class="status"></div>
  </div>

  <hr />

  <button id="btnViewFaculty">View Faculty</button>

  <table id="facultyTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Office</th>
        <th>Phone</th>
        <th>Email</th>
      </tr>
    </thead>
    <tbody id="facultyTableBody"></tbody>
  </table>
</div>

  <script>
    // Base URL (same origin as server)
    const BASE = '';

    // Pagination + search state for students
    let allStudents = [];
    let filteredStudents = [];
    let currentPage = 1;
    const pageSize = 10;

    // ---------- Helpers ----------
    function setStatus(id, message, isError = false) {
      const el = document.getElementById(id);
      el.textContent = message;
      el.classList.toggle('error', isError);
    }

    // ---------- Students: Add ----------
    document.getElementById('btnAddStudent').addEventListener('click', async () => {
      const studentNum = document.getElementById('studentNum').value.trim();
      const fName = document.getElementById('fName').value.trim();
      const lName = document.getElementById('lName').value.trim();
      const studentEmail = document.getElementById('studentEmail').value.trim();
      const studentMainPhone = document.getElementById('studentMainPhone').value.trim();

      if (!studentNum || !fName || !lName) {
        setStatus('addStatus', 'Student number, first, and last name are required.', true);
        return;
      }

      try {
        const res = await fetch(BASE + '/add_user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ studentNum, fName, lName, studentEmail, studentMainPhone })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Error adding student');

        setStatus('addStatus', data.message || 'Student added.');
        // refresh the list so we see the new student
        loadStudents();
      } catch (err) {
        console.error(err);
        setStatus('addStatus', err.message, true);
      }
    });

    // ---------- Students: Load from backend ----------
    async function loadStudents() {
      try {
        const res = await fetch(BASE + '/get_users');
        const data = await res.json();

        allStudents = data;
        filteredStudents = allStudents;
        currentPage = 1;
        renderStudentsTable();
      } catch (err) {
        console.error(err);
        alert('Error loading students: ' + err.message);
      }
    }

    // ---------- Students: Render current page ----------
    function renderStudentsTable() {
      const tbody = document.getElementById('studentsTableBody');
      tbody.innerHTML = '';

      if (!filteredStudents || filteredStudents.length === 0) {
        document.getElementById('pageInfo').textContent = 'No students to display.';
        document.getElementById('btnPrevPage').disabled = true;
        document.getElementById('btnNextPage').disabled = true;
        return;
      }

      const total = filteredStudents.length;
      const totalPages = Math.ceil(total / pageSize);
      if (currentPage > totalPages) currentPage = totalPages;

      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, total);
      const pageItems = filteredStudents.slice(startIndex, endIndex);

      pageItems.forEach((s) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.studentNum}</td>
          <td>${s.fName || ''}</td>
          <td>${s.lName || ''}</td>
          <td>${s.studentEmail || ''}</td>
          <td>${s.studentMainPhone || ''}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('pageInfo').textContent =
        `Showing ${startIndex + 1}-${endIndex} of ${total} student(s). ` +
        `(Page ${currentPage} of ${totalPages})`;

      document.getElementById('btnPrevPage').disabled = currentPage === 1;
      document.getElementById('btnNextPage').disabled = currentPage === totalPages;
    }

    document.getElementById('btnViewStudents').addEventListener('click', loadStudents);

    // ---------- Students: Search ----------
    function applyStudentSearch() {
      const q = document.getElementById('studentSearch').value.trim().toLowerCase();

      if (!q) {
        filteredStudents = allStudents;
      } else {
        filteredStudents = allStudents.filter((s) => {
          const num = String(s.studentNum || '');
          const fn = (s.fName || '').toLowerCase();
          const ln = (s.lName || '').toLowerCase();
          const em = (s.studentEmail || '').toLowerCase();
          return (
            num.includes(q) ||
            fn.includes(q) ||
            ln.includes(q) ||
            em.includes(q)
          );
        });
      }

      currentPage = 1;
      renderStudentsTable();
    }

    document
      .getElementById('btnSearchStudents')
      .addEventListener('click', applyStudentSearch);

    document
      .getElementById('btnClearSearch')
      .addEventListener('click', () => {
        document.getElementById('studentSearch').value = '';
        filteredStudents = allStudents;
        currentPage = 1;
        renderStudentsTable();
      });

    document
      .getElementById('studentSearch')
      .addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          applyStudentSearch();
        }
      });

    // ---------- Students: Pagination buttons ----------
    document
      .getElementById('btnPrevPage')
      .addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderStudentsTable();
        }
      });

    document
      .getElementById('btnNextPage')
      .addEventListener('click', () => {
        const totalPages = Math.ceil(filteredStudents.length / pageSize);
        if (currentPage < totalPages) {
          currentPage++;
          renderStudentsTable();
        }
      });

    // ---------- Students: Update ----------
    document
      .getElementById('btnUpdateStudent')
      .addEventListener('click', async () => {
        const studentNum = document.getElementById('updStudentNum').value.trim();
        const studentEmail = document.getElementById('updEmail').value.trim();
        const studentMainPhone = document.getElementById('updPhone').value.trim();

        if (!studentNum) {
          setStatus('updateStatus', 'Student number is required.', true);
          return;
        }

        try {
          const res = await fetch(BASE + '/students/' + encodeURIComponent(studentNum), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ studentEmail, studentMainPhone })
          });

          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Error updating student');

          setStatus('updateStatus', data.message || 'Student updated.');
          loadStudents();
        } catch (err) {
          console.error(err);
          setStatus('updateStatus', err.message, true);
        }
      });

    // ---------- Students: Delete ----------
    document
      .getElementById('btnDeleteStudent')
      .addEventListener('click', async () => {
        const studentNum = document.getElementById('delStudentNum').value.trim();
        if (!studentNum) {
          setStatus('deleteStatus', 'Student number is required.', true);
          return;
        }

        if (!confirm('Are you sure you want to delete student ' + studentNum + '?')) {
          return;
        }

        try {
          const res = await fetch(BASE + '/students/' + encodeURIComponent(studentNum), {
            method: 'DELETE'
          });

          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Error deleting student');

          setStatus('deleteStatus', data.message || 'Student deleted.');
          loadStudents();
        } catch (err) {
          console.error(err);
          setStatus('deleteStatus', err.message, true);
        }
      });

    // ---------- Professor Courses (JOIN) ----------
    document
      .getElementById('btnProfessorCourses')
      .addEventListener('click', async () => {
        const professorID = document.getElementById('professorIDInput').value.trim();
        if (!professorID) {
          setStatus('profCourseStatus', 'Professor ID is required.', true);
          return;
        }

        try {
          const res = await fetch(
            BASE + '/professors/' + encodeURIComponent(professorID) + '/courses'
          );
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Error fetching courses');

          const tbody = document.getElementById('professorCoursesBody');
          tbody.innerHTML = '';

          data.forEach((c) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${c.courseID}</td>
              <td>${c.courseName || ''}</td>
              <td>${c.taName || ''}</td>
              <td>${c.deptEmail || ''}</td>
            `;
            tbody.appendChild(tr);
          });

          setStatus('profCourseStatus', `Found ${data.length} course(s).`);
        } catch (err) {
          console.error(err);
          setStatus('profCourseStatus', err.message, true);
        }
      });

    // ---------- Course Enrollment Report (JOIN + GROUP BY) ----------
    document
      .getElementById('btnCourseEnrollment')
      .addEventListener('click', async () => {
        try {
          const res = await fetch(BASE + '/reports/course-enrollment');
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Error fetching report');

          const tbody = document.getElementById('courseEnrollmentBody');
          tbody.innerHTML = '';

          data.forEach((row) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${row.courseID}</td>
              <td>${row.courseName || ''}</td>
              <td>${row.numStudents}</td>
            `;
            tbody.appendChild(tr);
          });

          setStatus('enrollmentStatus', 'Report loaded: ' + data.length + ' course(s).');
        } catch (err) {
          console.error(err);
          setStatus('enrollmentStatus', err.message, true);
        }
      });

    // Load initial student page on first load
    loadStudents();

        // ---------- Faculty: Add ----------
    document.getElementById("btnAddFaculty").addEventListener("click", async () => {
      const facultyName = document.getElementById("facultyName").value.trim();
      const facultyOffice = document.getElementById("facultyOffice").value.trim();
      const facultyMainPhone = document.getElementById("facultyMainPhone").value.trim();
      const facultyEmail = document.getElementById("facultyEmail").value.trim();


      if (!facultyName) {
        setStatus("facultyAddStatus", "Faculty name is required.", true);
        return;
      }

      try {
        const res = await fetch("/add_faculty", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ facultyName, facultyOffice, facultyMainPhone, facultyEmail })
        });

        const data = await res.text();
        setStatus("facultyAddStatus", data);
      } catch (err) {
        setStatus("facultyAddStatus", err.message, true);
      }
    });

    // ---------- Faculty: View ----------
    document.getElementById("btnViewFaculty").addEventListener("click", async () => {
      try {
        const res = await fetch("/get_faculty");
        const rows = await res.json();
        const tbody = document.getElementById("facultyTableBody");
        tbody.innerHTML = "";

        rows.forEach(f => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${f.facultyName}</td>
            <td>${f.facultyOffice || ""}</td>
            <td>${f.facultyMainPhone || ""}</td>
            <td>${f.facultyEmail || ""}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        alert("Error loading faculty: " + err.message);
      }
    });
  </script>
</body>
</html>
